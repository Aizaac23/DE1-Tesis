---
title: "Análisis ANOVA de Nutrientes"
author: "Usuario"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)
library(readxl)
library(dplyr)
library(purrr)
library(lmtest)
library(tidyr)
library(ggplot2)
library(emmeans)
library(multcomp)
```

## 1. Carga y preparación de datos

```{r data-loading}
# Leer datos sin nombres automáticos
cuadro3 <- read_excel("C:/Users/manol/Escritorio/parcelas.xlsx",
                      col_names = FALSE)

# Selección y renombrado de columnas
datos <- cuadro3[5:nrow(cuadro3), c(2,3,4,5,9,13,17,21,25)] %>%
  setNames(c("repeticion","niveles","Variedades","Mg","Na","Fe","Cu","Mn","Zn")) %>%
  mutate(
    across(c(Mg, Na, Fe, Cu, Mn, Zn), as.numeric),
    repeticion = factor(repeticion),
    niveles    = factor(niveles),
    Variedad   = factor(Variedades,
                        levels = c(1,2,3),
                        labels = c("Sajama","Blanca de Juli","Tahuaco")),
    parcela    = interaction(repeticion, niveles)
  )
```

## 2. Ajuste de modelos ANOVA 

```{r models}
mod_Mg <- aov(Mg ~ repeticion + Error(parcela) + Variedades + niveles*Variedades, datos)
summary(mod_Mg)
```
- **Magnesio (Mg)**  
  - Estrato parcela: bloque significativo (F = 16.21, p = 0.000568) y niveles de fertilidad significativos (F = 69.70, p < 0.001).  
  - Estrato subparcelas: variedad significativo (F = 129.53, p < 0.001) e interacción variedades:niveles significativa (F = 4.41, p = 0.0039).  
  Esto indica que los niveles de fertilidad y la variedad afectan la absorción de Mg, y que cada variedad responde de forma distinta a los niveles.
```{r models2}
mod_Na <- aov(Na ~ repeticion + Error(parcela) + Variedades + niveles*Variedades, datos)
summary(mod_Na)
```
- **Sodio (Na)**  
  - Bloque (F = 19.55, p = 0.000279) y niveles (F = 266.64, p < 0.001) altamente significativos.  
  - Variedades (F = 148.80, p < 0.001) e interacción (F = 29.50, p < 0.001).  
  La jerarquía de absorción es Tahuaco > Blanca de Juli > Sajama, y la respuesta a la fertilización varía según la variedad.

```{r models3}
mod_Fe <- aov(Fe ~ repeticion + Error(parcela) + Variedades + niveles*Variedades, datos)
summary(mod_Fe)
```
- **Hierro (Fe)**  
  - Bloque (F = 23.57, p = 0.000134) y niveles (F = 198.76, p < 0.001) significativos.  
  - Variedades no significativo (F = 0.61, p = 0.554), pero interacción significativa (F = 3.40, p = 0.0142).  
  Aunque en promedio no hay diferencias entre variedades, cada variedad muestra un patrón distinto de respuesta a los niveles.

```{r models4}
mod_Cu <- aov(Cu ~ repeticion + Error(parcela) + Variedades + niveles*Variedades, datos)
summary(mod_Cu)
```
- **Cobre (Cu)**  
  - Bloque (F = 21.55, p = 0.000191) y niveles (F = 141.22, p < 0.001) significativos.  
  - Variedades (F = 92.96, p < 0.001) e interacción (F = 4.15, p = 0.0053).  

```{r models5}
mod_Mn <- aov(Mn ~ repeticion + Error(parcela) + Variedades + niveles*Variedades, datos)
summary(mod_Mn)
```
- **Manganeso (Mn)**  
  - Bloque (F = 20.61, p = 0.000227) y niveles (F = 175.62, p < 0.001) significativos.  
  - Variedades (F = 225.60, p < 0.001) e interacción (F = 11.10, p < 0.001).

```{r models6}
mod_Zn <- aov(Zn ~ repeticion + Error(parcela) + Variedades + niveles*Variedades, datos)
summary(mod_Zn)
```
- **Zinc (Zn)**  
  - Bloque (F = 13.31, p = 0.00117) y niveles (F = 36.20, p < 0.001) significativos.  
  - Variedades (F = 84.21, p < 0.001) e interacción (F = 6.75, p < 0.001).


## 4. Supuestos de los modelos

### 4.1 Normalidad de residuos

```{r shapiro}
mod_Mg$Within$residuals %>% shapiro.test()
mod_Na$Within$residuals %>% shapiro.test()
mod_Fe$Within$residuals %>% shapiro.test()
mod_Cu$Within$residuals %>% shapiro.test()
mod_Mn$Within$residuals %>% shapiro.test()
mod_Zn$Within$residuals %>% shapiro.test()
```

**Interpretación**:  
- Para Mg, W = 0.9084, p = 0.0102 < 0.05 → residuos no siguen normalidad estricta.  
- Para Na y Zn, se cumple normalidad (p > 0.05).  
- Fe, Cu y Mn cumplen también (cada p > 0.05).

### 4.2 Homogeneidad de varianzas

```{r bptest}
bptest(residuals(mod_Mg$Within) ~ fitted(mod_Mg$Within), data = datos)
bptest(residuals(mod_Na$Within) ~ fitted(mod_Na$Within), data = datos)
bptest(residuals(mod_Fe$Within) ~ fitted(mod_Fe$Within), data = datos)
bptest(residuals(mod_Cu$Within) ~ fitted(mod_Cu$Within), data = datos)
bptest(residuals(mod_Mn$Within) ~ fitted(mod_Mn$Within), data = datos)
bptest(residuals(mod_Zn$Within) ~ fitted(mod_Zn$Within), data = datos)
```

**Interpretación**:  
- Todos los tests BP tienen p > 0.05, indicando varianzas homogéneas en los estratos subparcelas.

## 5. Gráfico de medias y barras de error

```{r plot-means}
# Recodificar niveles como tratamiento con etiquetas
datos <- datos %>%
  mutate(
    Tratamiento = factor(
      niveles,
      levels = c("1", "2", "3", "4"),
      labels = c(
        "D1: 0-0-0",
        "D2: 60-40-30",
        "D3: 90-60-45",
        "D4: 120-80-60"
      )
    )
  )

# Crear tabla de resumen
summary_tbl <- datos %>%
  pivot_longer(cols = Mg:Zn, names_to = "Nutriente", values_to = "Absorcion") %>%
  group_by(Tratamiento, Variedad, Nutriente) %>%
  summarise(
    Media = mean(Absorcion, na.rm = TRUE),
    SE    = sd(Absorcion, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Gráfico con etiquetas verticales
ggplot(summary_tbl, aes(x = Tratamiento, y = Media, color = Variedad, group = Variedad)) +
  geom_line() +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = Media - SE, ymax = Media + SE), width = 0.2) +
  facet_wrap(~ Nutriente, scales = "free_y") +
  labs(
    x    =  "Niveles",
    y     = "Absorción promedio",
    color = "Variedad"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5, hjust = 1)
  )



```


## 6. Comparaciones múltiples con Tukey

### 6.1 Variedades

```{r tukey-var}
# b) Medias marginales de variedades (subplots) con Tukey

emm_Na_var <- emmeans(mod_Na, ~ Variedades)
pairs(emm_Na_var, adjust = "tukey")

emm_Fe_var <- emmeans(mod_Fe, ~ Variedades)
pairs(emm_Fe_var, adjust = "none")

emm_Cu_var <- emmeans(mod_Cu, ~ Variedades)
pairs(emm_Cu_var, adjust = "none")

emm_Mn_var <- emmeans(mod_Mn, ~ Variedades)
pairs(emm_Mn_var, adjust = "none")

emm_Zn_var <- emmeans(mod_Zn, ~ Variedades)
pairs(emm_Zn_var, adjust = "none")

```

**Interpretación**:  
- Na, Cu, Mn: todas las parejas difieren (Tahuaco > Blanca > Sajama).  
- Fe: no hay diferencias.  
- Zn: Sajama < {Blanca, Tahuaco}.

### 6.2 Niveles

```{r tukey-niv}
emm_Na_niv <- emmeans(mod_Na, ~ niveles)
pairs(emm_Na_niv, adjust = "tukey")

emm_Fe_niv <- emmeans(mod_Fe, ~ niveles)
pairs(emm_Fe_niv, adjust = "tukey")

emm_Cu_niv <- emmeans(mod_Cu, ~ niveles)
pairs(emm_Cu_niv, adjust = "tukey")

emm_Mn_niv <- emmeans(mod_Mn, ~ niveles)
pairs(emm_Mn_niv, adjust = "tukey")

emm_Zn_niv <- emmeans(mod_Zn, ~ niveles)
pairs(emm_Zn_niv, adjust = "tukey")


```

**Interpretación**:  
- Na y Fe: cada salto de nivel es significativo (4 > 3 > 2 > 1).  
- Cu y Mn: suben hasta nivel 3 y se estancan (3 ≈ 4).  
- Zn: gran salto 1→2 y luego meseta (2 ≈ 3 ≈ 4).

### 6.3 Interacción

```{r tukey-int}
emm_Na_int <- emmeans(mod_Na, ~ niveles*Variedades)
pairs(emm_Na_int, adjust = "tukey")

emm_Fe_int <- emmeans(mod_Fe, ~ niveles*Variedades)
pairs(emm_Fe_int, adjust = "tukey")

emm_Cu_int <- emmeans(mod_Cu, ~ niveles*Variedades)
pairs(emm_Cu_int, adjust = "tukey")

emm_Mn_int <- emmeans(mod_Mn, ~ niveles*Variedades)
pairs(emm_Mn_int, adjust = "tukey")

emm_Zn_int <- emmeans(mod_Zn, ~ niveles*Variedades)
pairs(emm_Zn_int, adjust = "tukey")

```

**Interpretación**:  
- Confirma que cada variedad difiere en su respuesta a niveles, p.ej., Sodio: Tahuaco pico en nivel 3, Blanca pico en 4, Sajama crece linealmente.
